# System Architecture - 77 GHz Handheld SAR Radar

## 1. System Overview

The handheld SAR radar is a portable imaging system operating at 77 GHz (W-band) that creates high-resolution 2D images of the environment using synthetic aperture techniques. The system is designed for short-range imaging (0.5-5 m) with centimeter-level resolution.

### High-Level Block Diagram

```
+------------------+     LVDS (4ch)     +------------------+
|                  |  ===============>  |                  |
|   AWR2243        |                    |   FPGA           |
|   mmWave Radar   |  <--- SPI ------  |   (Artix-7)      |
|   Transceiver    |                    |                  |
|                  |  <--- CLK ------  |   - Data Capture |
+------------------+                    |   - Range FFT    |
       |                                |   - Buffering    |
       |  3TX / 4RX                     |                  |
       |  77 GHz                        +--------+---------+
       |                                         |
+------v-------+                          SPI    |  SD Card
|  Patch       |                        +--------v---------+
|  Antenna     |                        |                  |
|  Array       |                        |   ESP32-S3       |
|  (MIMO)      |                        |                  |
+--------------+                        |   - WiFi AP      |
                                        |   - SD Write     |
+------------------+                    |   - IMU Read     |
|  IMU (ICM-42688) | --- SPI -------->  |   - Battery Mgmt |
|  9-axis          |                    |   - UI/Status    |
+------------------+                    +--------+---------+
                                                 |
+------------------+                      WiFi   |  TCP
|  Battery Pack    |                    +--------v---------+
|  Samsung 21700   |  --- Power ---->   |                  |
|  2S1P (7.4V)     |                    |   Host PC        |
|  29.6 Wh         |                    |   (Laptop)       |
+------------------+                    |                  |
                                        |   - SAR BPA      |
+------------------+                    |   - CUDA Accel.  |
|  Power Mgmt      |                    |   - GUI Display  |
|  BQ25895 Charger |                    |   - Post-proc    |
|  TPS62160 (5V)   |                    +------------------+
|  TPS7A47 (analog)|
|  ADP1720 (1.2V)  |
+------------------+
```

## 2. Data Flow Pipeline

### 2.1 Signal Acquisition Path

```
AWR2243 TX Output (77 GHz FMCW chirp)
    |
    v
Target Reflection (round-trip delay)
    |
    v
AWR2243 RX Input (reflected signal)
    |
    v
AWR2243 Mixer (dechirp / stretch processing)
    |
    v
AWR2243 IF Output (beat signal, 0-10 MHz)
    |
    v
AWR2243 Internal ADC (12-bit, 10 MSPS per channel)
    |
    v  LVDS (4 differential pairs, 600 Mbps each)
    |
FPGA Data Capture Module
    |
    v  BRAM Buffer (capture buffer)
    |
FPGA Range FFT Engine (512-point, radix-2)
    |
    v  BRAM Buffer (FFT output buffer)
    |
    +---> SD Card (via SPI through ESP32) --> Offline Processing
    |
    +---> WiFi TCP Stream (via ESP32) --> Real-time Processing on PC
```

### 2.2 Processing Path (Host PC)

```
Raw Range Profiles (from SD or WiFi)
    |
    v
Motion Data Fusion (IMU + scan position)
    |
    v
Motion Compensation (phase correction)
    |
    v
Back-Projection Algorithm (CUDA GPU)
    |
    v
Autofocus (Phase Gradient Autofocus)
    |
    v
SAR Image (magnitude + phase)
    |
    v
Display / Export
```

## 3. Clock Domains

| Clock Domain | Frequency | Source | Usage |
|---|---|---|---|
| System Clock | 100 MHz | FPGA PLL (from 25 MHz XTAL) | FPGA logic, state machines, general control |
| DSP Clock | 200 MHz | FPGA PLL | Range FFT engine, data processing |
| SPI Master | 25 MHz | FPGA clock divider | AWR2243 configuration SPI |
| LVDS Clock | 600 Mbps DDR | AWR2243 output clock | ADC data capture (300 MHz DDR) |
| ESP32 SPI | 40 MHz | ESP32 internal PLL | SD card write, FPGA-ESP32 data transfer |
| IMU SPI | 10 MHz | ESP32 clock divider | ICM-42688-P accelerometer/gyro readout |
| WiFi Baseband | 160 MHz | ESP32 internal | 802.11n WiFi data transmission |

### Clock Domain Crossings

- **LVDS -> System**: Asynchronous FIFO with gray-code pointers (16-deep, 32-bit wide)
- **System -> DSP**: Synchronous (DSP clock is 2x system, derived from same PLL)
- **System -> ESP32 SPI**: SPI clock generated by ESP32 (slave FIFO on FPGA side)
- **IMU -> ESP32**: Direct SPI master on ESP32

## 4. Data Rate Analysis

### 4.1 Raw ADC Data

```
Per channel:
  12-bit samples x 10 MSPS = 120 Mbps = 15 MB/s

4 RX channels:
  4 x 15 MB/s = 60 MB/s

With 16-bit packing (12-bit padded to 16-bit):
  4 x 20 MB/s = 80 MB/s peak

Effective (during chirps only, ~50% duty cycle):
  ~40 MB/s average
```

### 4.2 After Range FFT (FPGA Output)

```
Per chirp:
  512-point complex FFT = 512 x 2 x 16-bit = 2048 bytes
  Only positive frequencies kept: 256 x 2 x 16-bit = 1024 bytes
  4 channels: 4096 bytes per chirp

Chirp rate: 1 / (60us + 20us idle) = 12,500 chirps/sec
  4096 x 12,500 = 51.2 MB/s (all channels)

For SAR (single channel, range profiles only):
  1024 x 12,500 = 12.8 MB/s
```

### 4.3 Data Transfer Bottlenecks

| Interface | Max Throughput | Actual Usage | Margin |
|---|---|---|---|
| LVDS (4ch) | 4 x 600 Mbps = 300 MB/s | ~80 MB/s | 3.75x |
| FPGA BRAM | 200 MHz x 32-bit = 800 MB/s | ~100 MB/s | 8x |
| SPI (FPGA->ESP32) | 40 MHz / 8 = 5 MB/s | ~3 MB/s | 1.7x |
| SD Card (SPI mode) | ~4 MB/s | ~3 MB/s | 1.3x |
| WiFi (TCP) | ~5 Mbps = 0.625 MB/s | ~0.5 MB/s | 1.25x |

**WiFi is the bottleneck** for real-time operation. Strategies to handle this:

1. **Decimation**: Send every Nth range profile (reduces cross-range resolution)
2. **Compression**: Simple delta encoding of range profiles (~2:1 compression)
3. **Selected Range Bins**: Send only range bins of interest (ROI)
4. **SD Card Primary**: Use SD card for full-rate recording, WiFi for preview only

### 4.4 SD Card Storage

```
Per scan (300 positions):
  Range profile: 256 x 2 x 2 bytes x 4 channels = 4096 bytes
  IMU data: 24 bytes (accel + gyro + timestamp)
  Header: 32 bytes
  Total per position: ~4152 bytes
  Total per scan: 300 x 4152 = 1.25 MB

32 GB SD card capacity:
  32,000 MB / 1.25 MB = ~25,600 scans
  At 1 scan/minute: ~17.8 days of continuous operation
```

## 5. FPGA Memory Map (BRAM Allocation)

Artix-7 XC7A35T: 50 Block RAMs (36 Kbit each) = 225 KB total

| Block | Address Range | Size | Description |
|---|---|---|---|
| LVDS Capture Buffer | 0x0000 - 0x3FFF | 16 KB | Double-buffered ADC capture (2 x 8KB) |
| FFT Input Buffer | 0x4000 - 0x5FFF | 8 KB | 512 x 4ch x 16-bit complex input staging |
| FFT Twiddle ROM | 0x6000 - 0x67FF | 2 KB | Pre-computed twiddle factors (sin/cos) |
| FFT Output Buffer | 0x6800 - 0x87FF | 8 KB | 512 x 4ch x 16-bit complex FFT output |
| SPI TX Buffer | 0x8800 - 0x8FFF | 2 KB | Data ready for ESP32 SPI transfer |
| SPI RX Buffer | 0x9000 - 0x97FF | 2 KB | Commands from ESP32 |
| AWR2243 Config ROM | 0x9800 - 0x9FFF | 2 KB | Radar configuration register values |
| Window Coeff ROM | 0xA000 - 0xA3FF | 1 KB | Hanning/Hamming window coefficients |
| Status Registers | 0xA400 - 0xA7FF | 1 KB | Control/status registers |
| **Total Used** | | **42 KB** | **~19% of available BRAM** |
| **Available** | | **183 KB** | For future expansion (CFAR, MTI, etc.) |

## 6. Power Budget

### 6.1 Component Power Consumption

| Component | Voltage | Current (typ) | Power (typ) | Power (max) | Notes |
|---|---|---|---|---|---|
| AWR2243 | 1.2V/1.8V/3.3V | Various | 1.3 W | 1.8 W | All TX active, continuous chirp |
| FPGA (XC7A35T) | 1.0V/1.8V/3.3V | Various | 1.2 W | 1.8 W | FFT running, LVDS active |
| ESP32-S3 | 3.3V | 150 mA | 0.5 W | 0.8 W | WiFi TX active |
| ICM-42688-P | 1.8V | 1 mA | 0.002 W | 0.003 W | All axes, 1 kHz ODR |
| SD Card | 3.3V | 100 mA | 0.33 W | 0.5 W | During write |
| OLED Display | 3.3V | 30 mA | 0.1 W | 0.15 W | 128x64 status display |
| Power Management | - | - | 0.2 W | 0.3 W | Regulators quiescent + losses |
| Misc (LEDs, etc.) | 3.3V | 20 mA | 0.07 W | 0.1 W | Status indicators |
| **Total** | | | **3.7 W** | **5.5 W** | |

### 6.2 Battery Life Estimation

```
Battery: 2S1P Samsung 21700 (50E)
  Nominal voltage: 7.4 V (2 x 3.7 V)
  Capacity: 4000 mAh per cell
  Energy: 7.4 V x 4.0 Ah = 29.6 Wh

Typical power consumption: 3.7 W
  Battery life: 29.6 Wh / 3.7 W = 8.0 hours

Maximum power consumption: 5.5 W (worst case)
  Battery life: 29.6 Wh / 5.5 W = 5.4 hours

Accounting for regulator efficiency (~85%):
  Typical: 29.6 * 0.85 / 3.7 = 6.8 hours
  Maximum: 29.6 * 0.85 / 5.5 = 4.6 hours

Design target: > 6 hours typical --> MEETS TARGET (6.8 hours)
```

### 6.3 Power Domain Architecture

```
Battery (7.4V)
    |
    +---> TPS62160 Buck --> 5.0V --> ESP32-S3 (via LDO 3.3V)
    |                           --> SD Card (3.3V)
    |                           --> OLED Display (3.3V)
    |
    +---> TPS62160 Buck --> 3.3V --> FPGA I/O banks
    |                           --> AWR2243 digital (3.3V)
    |
    +---> TPS7A47 LDO --> 1.8V --> AWR2243 analog (ultra-low noise)
    |                          --> FPGA auxiliary
    |                          --> ICM-42688
    |
    +---> ADP1720 LDO --> 1.0V/1.2V --> FPGA core
    |                               --> AWR2243 core
    |
    +---> BQ25895 --> Charge management (USB-C input)
```

## 7. Scan Modes

### 7.1 Linear Scan (Rail-Mounted)

- **Mechanism**: Device slides along a precision linear rail
- **Aperture length**: 30 cm (adjustable)
- **Step size**: 1 mm (lambda/4 at 77 GHz for Nyquist)
- **Positions**: 300
- **Scan time**: ~10 seconds (manual slide)
- **Position accuracy**: < 0.5 mm (rail precision)
- **Best for**: Calibration, high-quality imaging, repeatable measurements

### 7.2 Freehand Scan (IMU-Assisted)

- **Mechanism**: User sweeps the handheld device through the air
- **IMU**: ICM-42688-P (6-axis accel/gyro, 1 kHz)
- **Position estimation**: Double-integrated accelerometer with ZUPT correction
- **Expected accuracy**: 1-5 mm (depends on scan speed and ZUPT frequency)
- **Autofocus**: Phase Gradient Autofocus (PGA) compensates residual errors
- **Best for**: Field use, quick surveys, non-destructive testing

### 7.3 Scan Trigger Modes

| Mode | Trigger | Description |
|---|---|---|
| Continuous | Timer | Chirp every 80 us, capture all positions |
| Position-based | IMU | Trigger chirp when moved >= 1 mm from last position |
| Manual | Button | User triggers each capture point |
| External | GPIO | External trigger input (for motorized stages) |

## 8. Data Formats

### 8.1 SD Card Binary Format (`.sar`)

```
File Header (64 bytes):
  [0:4]   Magic number: "SAR1" (0x53415231)
  [4:8]   File version: uint32
  [8:16]  Timestamp: uint64 (Unix epoch, microseconds)
  [16:20] Number of positions: uint32
  [20:24] Samples per chirp: uint32
  [24:28] Number of channels: uint32
  [28:32] Center frequency: float32 [Hz]
  [32:36] Bandwidth: float32 [Hz]
  [36:40] Chirp duration: float32 [s]
  [40:44] Sample rate: float32 [Hz]
  [44:48] Scan mode: uint32 (0=linear, 1=freehand)
  [48:64] Reserved

Per-Position Record:
  Position Header (32 bytes):
    [0:4]   Position index: uint32
    [4:8]   Timestamp delta: uint32 [us from start]
    [8:12]  IMU accel_x: float32 [m/s^2]
    [12:16] IMU accel_y: float32
    [16:20] IMU accel_z: float32
    [20:24] IMU gyro_x: float32 [rad/s]
    [24:28] IMU gyro_y: float32
    [28:32] IMU gyro_z: float32

  ADC Data (N_samples * N_channels * 4 bytes):
    Complex int16 pairs: [I_0, Q_0, I_1, Q_1, ...]
    Channel interleaved: [ch0_sample0, ch1_sample0, ..., ch0_sample1, ...]
```

### 8.2 WiFi TCP Stream Format

```
Packet Header (16 bytes):
  [0:2]   Sync word: 0xAA55
  [2:4]   Packet type: uint16 (0=range_profile, 1=status, 2=imu)
  [4:8]   Sequence number: uint32
  [8:12]  Payload length: uint32
  [12:16] Checksum (CRC-16 of payload + zero-padded)

Payload (variable):
  Type 0 (Range Profile):
    Position index: uint16
    Channel: uint16
    Range bins: N x complex int16 (I, Q pairs)

  Type 1 (Status):
    Battery voltage: float32
    Temperature: float32
    Scan progress: uint16
    Error flags: uint16

  Type 2 (IMU):
    Same as position header IMU fields (24 bytes)
```

## 9. Error Handling and Safety

### 9.1 Watchdog Timers

- **FPGA**: Internal watchdog resets data capture if no valid LVDS data for > 1 ms
- **ESP32**: Hardware WDT (5 second timeout), software WDT (3 second timeout)
- **AWR2243**: Monitored via SPI status register polling (100 ms interval)

### 9.2 RF Safety

- **Maximum EIRP**: 12 dBm + 10 dBi = 22 dBm (158 mW)
- **Power density at 10 cm**: ~50 mW/cm^2 (below 77 GHz safety limit of 100 mW/cm^2 for occupational exposure per IEEE C95.1)
- **Minimum safe distance**: 7 cm (calculated from EIRP and power density limit)
- **Auto-shutoff**: Proximity sensor disables TX if object detected < 5 cm

### 9.3 Battery Protection

- BQ25895 provides overcharge, over-discharge, overcurrent, and short-circuit protection
- Temperature monitoring via NTC thermistor on battery pack
- Automatic shutdown if battery voltage < 6.0 V (2 x 3.0 V per cell)
- USB-C PD negotiation for safe charging (5V/3A or 9V/2A)
